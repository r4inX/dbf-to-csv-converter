{% extends "base.html" %}

{% block content %}
{% if dbf_info.error %}
    <div class="card">
        <h2>‚ùå Error Reading File</h2>
        <div class="alert alert-error">
            {{ dbf_info.error }}
        </div>
        <a href="/" class="btn">‚Üê Try Another File</a>
    </div>
{% else %}
    <div class="card">
        <h2>üìä File Preview: {{ dbf_info.filename }}</h2>
        
        <!-- File Information -->
        <div class="info-grid">
            <div class="info-item">
                <div class="value">{{ "{:,}".format(dbf_info.record_count) }}</div>
                <div class="label">Records</div>
            </div>
            <div class="info-item">
                <div class="value">{{ dbf_info.field_count }}</div>
                <div class="label">Fields</div>
            </div>
            <div class="info-item">
                <div class="value">{{ "%.1f"|format(dbf_info.file_size / 1024) }} KB</div>
                <div class="label">File Size</div>
            </div>
            <div class="info-item">
                <div class="value">{{ dbf_info.encoding_used }}</div>
                <div class="label">Detected Encoding</div>
            </div>
            {% if dbf_info.companion_files %}
            <div class="info-item">
                <div class="value">{{ dbf_info.companion_files|length }}</div>
                <div class="label">Companion Files</div>
            </div>
            {% endif %}
        </div>
        
        <!-- Field Structure -->
        <h3>üìã Field Structure</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Field Name</th>
                    <th>Type</th>
                    <th>Length</th>
                </tr>
            </thead>
            <tbody>
                {% for field in dbf_info.fields %}
                <tr>
                    <td><strong>{{ field.name }}</strong></td>
                    <td>{{ field.type }}</td>
                    <td>{{ field.length }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        
        {% if dbf_info.companion_files %}
        <h3>üìé Companion Files</h3>
        <div class="alert alert-info">
            {% if dbf_info.uploaded_companions %}
            <strong>‚úÖ Uploaded with DBF:</strong>
            {% for file in dbf_info.uploaded_companions %}
                <span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">{{ file }}</span>
            {% endfor %}
            <br>
            {% endif %}
            {% if dbf_info.companion_files|length > (dbf_info.uploaded_companions|length if dbf_info.uploaded_companions else 0) %}
            <strong>üîç Auto-detected:</strong>
            {% for file in dbf_info.companion_files %}
                {% if not dbf_info.uploaded_companions or file not in dbf_info.uploaded_companions %}
                <span style="background: #667eea; color: white; padding: 2px 6px; border-radius: 3px; margin-right: 5px;">{{ file }}</span>
                {% endif %}
            {% endfor %}
            {% endif %}
        </div>
        {% endif %}
        
        <!-- Data Validation Preview -->
        {% if dbf_info.validation_preview %}
        <h3>üîç Data Quality Preview</h3>
        <div class="info-grid">
            <div class="info-item">
                <div class="value">{{ "%.0f"|format(dbf_info.validation_preview.encoding_confidence) }}%</div>
                <div class="label">Encoding Confidence</div>
            </div>
            <div class="info-item">
                <div class="value">{{ dbf_info.validation_preview.duplicates_in_sample }}</div>
                <div class="label">Duplicates in Sample</div>
            </div>
            <div class="info-item">
                <div class="value">{{ dbf_info.validation_preview.sample_field_analysis|length }}</div>
                <div class="label">Fields Analyzed</div>
            </div>
        </div>
        {% endif %}
        
        <!-- Sample Data -->
        {% if dbf_info.sample_records %}
        <h3>üëÄ Sample Data (First 3 Records)</h3>
        <div style="overflow-x: auto;">
            <table class="table">
                <thead>
                    <tr>
                        {% for field in dbf_info.fields %}
                        <th>{{ field.name }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for record in dbf_info.sample_records %}
                    <tr>
                        {% for field in dbf_info.fields %}
                        <td>{{ record.get(field.name, '') | string | truncate(30) }}</td>
                        {% endfor %}
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% elif dbf_info.sample_error %}
        <h3>üëÄ Sample Data</h3>
        <div class="alert alert-info">
            <strong>Note:</strong> {{ dbf_info.sample_error }}
            <br>Field structure is available, but sample data could not be read. Conversion may still work.
        </div>
        {% endif %}
    </div>
    
    <!-- Conversion Options -->
    <div class="card">
        <h2>‚öôÔ∏è Conversion Options</h2>
        <form id="convertForm">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <input type="hidden" name="original_filename" value="{{ original_filename }}">
            
            <div class="form-group">
                <label for="delimiter">CSV Delimiter:</label>
                <select name="delimiter" id="delimiter" class="form-control">
                    <option value=";">Semicolon (;) - German Standard</option>
                    <option value=",">Comma (,) - International</option>
                    <option value="|">Pipe (|)</option>
                    <option value="&#9;">Tab</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="encoding">Output Encoding:</label>
                <select name="encoding" id="encoding" class="form-control">
                    <option value="utf-8">UTF-8 (Recommended)</option>
                    <option value="cp1252">Windows-1252 (Western European)</option>
                    <option value="iso-8859-1">ISO-8859-1 (Latin-1)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>
                    <input type="checkbox" name="run_validation" id="runValidation" style="margin-right: 8px;">
                    Run comprehensive data quality validation
                </label>
                <p style="font-size: 0.9rem; color: #6c757d; margin-top: 4px;">
                    Analyzes duplicates, data types, missing values, and overall quality score
                </p>
            </div>
            
            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                <button type="submit" class="btn btn-success">
                    üîÑ Convert to CSV
                </button>
                <button type="button" class="btn" id="validateBtn">
                    üîç Run Data Validation
                </button>
                <button type="button" class="btn btn-warning" id="testBtn">
                    üß™ Test Function
                </button>
                <button type="button" class="btn btn-info" id="debugBtn">
                    üêõ Debug Functions
                </button>
                <a href="/" class="btn btn-secondary">
                    ‚Üê Upload Different File
                </a>
            </div>
        </form>
        
        <!-- Progress Bar -->
        <div id="progressSection" style="display: none; margin-top: 2rem;">
            <h4>Converting...</h4>
            <div class="progress">
                <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            </div>
            <p id="progressText">Starting conversion...</p>
        </div>
        
        <!-- Download Section -->
        <div id="downloadSection" style="display: none; margin-top: 2rem;">
            <div class="alert alert-success">
                <strong>‚úÖ Conversion Complete!</strong>
                Your CSV file is ready for download.
            </div>
            <a id="downloadLink" class="btn btn-success" download>
                üì• Download CSV File
            </a>
            <button type="button" class="btn btn-secondary" onclick="cleanupAndReturn()">
                üóëÔ∏è Clean Up & Return
            </button>
        </div>
        
        <!-- Validation Results Section -->
        <div id="validationSection" style="display: none; margin-top: 2rem;">
            <h3>üìä Data Quality Validation Results</h3>
            <div id="validationResults"></div>
        </div>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Test function
window.testFunction = function() {
    alert('Test function works!');
};

// Debug function to check what's available
window.debugFunctions = function() {
    console.log('window.runValidation:', typeof window.runValidation);
    console.log('window.testFunction:', typeof window.testFunction);
    console.log('window.cleanupAndReturn:', typeof window.cleanupAndReturn);
    alert('Check console for function debug info');
};

// Global cleanup function
window.cleanupAndReturn = function() {
    const sessionId = document.querySelector('input[name="session_id"]').value;
    fetch(`/cleanup/${sessionId}`)
    .then(() => {
        window.location.href = '/';
    })
    .catch(() => {
        window.location.href = '/';
    });
};

// Global validation function
window.runValidation = function() {
    console.log('runValidation function called successfully!');
    alert('Validation button clicked!');
    
    const convertForm = document.getElementById('convertForm');
    const validationSection = document.getElementById('validationSection');
    
    if (!convertForm) {
        alert('Convert form not found!');
        return;
    }
    
    if (!validationSection) {
        alert('Validation section not found!');
        return;
    }
    
    const formData = new FormData(convertForm);
    console.log('FormData created');
    
    validationSection.style.display = 'block';
    document.getElementById('validationResults').innerHTML = '<div class="alert alert-info">Running validation analysis...</div>';
    
    fetch('/validate', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        console.log('Validation data received:', data);
        if (data.success) {
            displayValidationResults(data.validation_results);
        } else {
            document.getElementById('validationResults').innerHTML = 
                '<div class="alert alert-error">Validation failed: ' + data.error + '</div>';
        }
    })
    .catch(error => {
        console.error('Validation error:', error);
        document.getElementById('validationResults').innerHTML = 
            '<div class="alert alert-error">Network error: ' + error.message + '</div>';
    });
};

// Ensure the function is available immediately
console.log('Functions defined - window.runValidation:', typeof window.runValidation);

// Validation results display function
function displayValidationResults(results) {
    const html = `
        <div class="alert alert-success">
            <strong>üìä Quality Score: ${results.quality_score.overall_score.toFixed(1)}</strong><br>
            <strong>Grade: ${results.summary.overall_quality}</strong><br>
            <strong>Duplicates: ${results.duplicates.total_duplicates}</strong><br>
            <strong>Encoding: ${results.encoding_confidence.confidence_level}</strong>
        </div>
    `;
    document.getElementById('validationResults').innerHTML = html;
}

// DOM ready event listener for form handling
document.addEventListener('DOMContentLoaded', function() {
    const convertForm = document.getElementById('convertForm');
    const progressSection = document.getElementById('progressSection');
    const downloadSection = document.getElementById('downloadSection');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const downloadLink = document.getElementById('downloadLink');
    
    // Add event listeners to buttons using IDs
    const validationBtn = document.getElementById('validateBtn');
    const testBtn = document.getElementById('testBtn');
    const debugBtn = document.getElementById('debugBtn');
    
    if (validationBtn) {
        validationBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Validation button clicked via event listener');
            if (window.runValidation) {
                window.runValidation();
            } else {
                alert('runValidation function not found!');
                console.error('window.runValidation is not defined');
            }
        });
    }
    
    if (testBtn) {
        testBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.testFunction) {
                window.testFunction();
            } else {
                alert('testFunction not found!');
            }
        });
    }
    
    if (debugBtn) {
        debugBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (window.debugFunctions) {
                window.debugFunctions();
            } else {
                alert('debugFunctions not found!');
            }
        });
    }
    
    convertForm.addEventListener('submit', function(e) {
        e.preventDefault();
        convertFile();
    });
    
    function convertFile() {
        progressSection.style.display = 'block';
        downloadSection.style.display = 'none';
        
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += Math.random() * 15;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
            progressText.textContent = `Converting... ${Math.round(progress)}%`;
        }, 200);
        
        const formData = new FormData(convertForm);
        
        fetch('/convert', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            clearInterval(progressInterval);
            progressBar.style.width = '100%';
            progressText.textContent = 'Conversion complete!';
            
            if (data.success) {
                downloadLink.href = data.download_url;
                setTimeout(() => {
                    progressSection.style.display = 'none';
                    downloadSection.style.display = 'block';
                }, 500);
            } else {
                alert('Conversion failed: ' + (data.error || 'Unknown error'));
                progressSection.style.display = 'none';
            }
        })
        .catch(error => {
            clearInterval(progressInterval);
            alert('Network error: ' + error.message);
            progressSection.style.display = 'none';
        });
    }
});
</script>
{% endblock %}